generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // 6543
  directUrl = env("DIRECT_URL") // 5432（shadow 用）
}

model Faq {
  id       String @id @default(uuid())
  schoolId String @unique
  items    Json

  // ▲ 追加：チャットボットの見た目・CTA・吹き出し用
  palette  String  @default("gray") // テーマカラー
  ctaLabel String? // CTA ボタン文言
  ctaUrl   String? // CTA ボタンURL

  launcherText String? // ★ NEW! ランチャーの吹き出し文言（例: "質問はコチラ"）

  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([updatedAt])
}

model FaqLog {
  id        Int      @id @default(autoincrement())
  school    String // 例: "daiki.maeda.web"
  sessionId String
  timestamp DateTime // 質問が行われた時刻

  question String
  answer   String?
  url      String?

  createdAt DateTime @default(now())

  @@index([school])
  @@index([sessionId])
  @@index([timestamp])
}

// ユーザーの権限ロール
enum UserRole {
  SUPERADMIN
  SCHOOL_ADMIN
}

// JSON の users を移行する先のテーブル
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  role         UserRole
  schoolId     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([role])
}

// SuperAdmin 一覧（メール＋schoolId）
model SuperAdmin {
  id        String   @id @default(cuid())
  email     String   @unique
  schoolId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/////////////////////////////////////////
// ここから診断機能用のモデル
/////////////////////////////////////////

// エリア・校舎情報（診断の選択肢）
model DiagnosisCampus {
  id        String  @id @default(cuid())
  schoolId  String // どの school の診断か
  label     String // 表示名（渋谷校など）
  slug      String // "shibuya" など（option.id に使う想定）
  sortOrder Int     @default(0)
  isOnline  Boolean @default(false)
  isActive  Boolean @default(true)

  // 診断結果に紐づく（多対多）
  results DiagnosisResult[] @relation("ResultCampuses")

  // ✅ 追加：講師と紐づく（多対多） ← これが無いのでエラー
  instructors DiagnosisInstructor[] @relation("InstructorCampuses")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, slug])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

// コース（レベル）選択肢
// コース（レベル）選択肢
model DiagnosisCourse {
  id        String  @id @default(cuid())
  schoolId  String
  label     String // 例: "超入門", "入門", "初級"
  slug      String // 例: "lv0", "lv1"
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  // ✅ 追加：Q2（経験・運動レベル）の回答タグに対応（複数）
  // 例: ["Q2_BEGINNER", "Q2_NO_EXERCISE"]
  q2AnswerTags String[] @default([])

  // 診断結果に紐づく（多対多）
  results DiagnosisResult[] @relation("ResultCourses")

  // ✅ 追加：講師と紐づく（多対多）
  instructors DiagnosisInstructor[] @relation("InstructorCourses")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, slug])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}


// ジャンル選択肢
model DiagnosisGenre {
  id       String @id @default(cuid())
  schoolId String
  label    String // 例: "K-POP", "HIPHOP"
  slug     String // 例: "kpop", "hiphop"

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  answerTag String? // 例: "Genre_KPOP"

  // 診断結果に紐づく（多対多）
  results DiagnosisResult[] @relation("ResultGenres")

  // ✅ 追加：講師と紐づく（多対多）
  instructors DiagnosisInstructor[] @relation("InstructorGenres")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, slug])
  @@unique([schoolId, answerTag]) // ✅ 同一school内で同じtagの二重紐づけ防止
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
  @@index([schoolId, answerTag])
}

// 講師選択肢（診断で選ばせたい講師のみ）
model DiagnosisInstructor {
  id        String  @id @default(cuid())
  schoolId  String
  label     String // 例: "田中先生"
  slug      String // 例: "tanaka"
  photoUrl  String? // 画像URL
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  // ★ 画像をDB保存（バイナリ）
  photoMime String? // "image/jpeg" など
  photoData Bytes? // 画像バイナリ

  // 診断結果に紐づく（多対多）
  results DiagnosisResult[] @relation("ResultInstructors")

  // ✅ 追加：コース/ジャンル紐づけ（多対多）
  courses DiagnosisCourse[] @relation("InstructorCourses")
  genres  DiagnosisGenre[]  @relation("InstructorGenres")

  // ✅ 追加：校舎紐づけ
  campuses DiagnosisCampus[] @relation("InstructorCampuses")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, slug])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

// 診断結果（おすすめ結果カード）
model DiagnosisResult {
  id        String  @id @default(cuid())
  schoolId  String
  title     String
  body      String?
  ctaLabel  String?
  ctaUrl    String?
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  campuses    DiagnosisCampus[]     @relation("ResultCampuses")
  courses     DiagnosisCourse[]     @relation("ResultCourses")
  genres      DiagnosisGenre[]      @relation("ResultGenres")
  instructors DiagnosisInstructor[] @relation("ResultInstructors")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

// クラス（コース）情報（既存：運用データ用の本体モデル）
model SchoolClass {
  id          String   @id @default(cuid())
  schoolId    String
  name        String // 例: "K-POP 超入門クラス"
  description String?
  // マッチング用タグ
  levels      String[] // 例: ["Lv0_超入門", "Lv1_入門"]
  targets     String[] // 例: ["Age_Teen", "Age_Student", "Age_Adult_Work"]
  genres      String[] // 例: ["Genre_KPOP"]
  schedule    String? // 例: "土曜・平日夜"
  isActive    Boolean  @default(true)

  teachers TeacherClass[] // 中間テーブル経由で Teacher へ

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([isActive])
}

// 講師情報（既存：運用データ用の本体モデル）
model Teacher {
  id       String   @id @default(cuid())
  schoolId String
  name     String
  photoUrl String?
  styles   String[] // 例: ["Style_Healing", "Style_Friendly"]
  bio      String?

  classes TeacherClass[] // 担当クラスとの中間

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
}

// クラス×講師の中間テーブル
model TeacherClass {
  id        String @id @default(cuid())
  classId   String
  teacherId String

  clazz   SchoolClass @relation(fields: [classId], references: [id])
  teacher Teacher     @relation(fields: [teacherId], references: [id])

  createdAt DateTime @default(now())

  @@unique([classId, teacherId])
  @@index([classId])
  @@index([teacherId])
}
