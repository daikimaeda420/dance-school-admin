generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Faq {
  id           String   @id @default(uuid())
  schoolId     String   @unique
  items        Json
  updatedBy    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  ctaLabel     String?
  ctaUrl       String?
  palette      String   @default("gray")
  launcherText String?

  @@index([updatedAt])
}

model FaqLog {
  id        Int      @id @default(autoincrement())
  school    String
  sessionId String
  timestamp DateTime
  question  String
  answer    String?
  url       String?
  createdAt DateTime @default(now())

  @@index([school])
  @@index([sessionId])
  @@index([timestamp])
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  role         UserRole
  schoolId     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([schoolId])
  @@index([role])
}

model SuperAdmin {
  id        String   @id @default(cuid())
  email     String   @unique
  schoolId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DiagnosisCampus {
  id        String   @id @default(cuid())
  schoolId  String
  label     String
  slug      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  address String?
  access  String?

  // ✅ Google Map（外部リンク用）
  googleMapUrl String?

  // ✅ Google Map（iframe埋め込み用）
  googleMapEmbedUrl String?

  results DiagnosisResult[] @relation("ResultCampuses")

  @@unique([schoolId, slug])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

model DiagnosisCourse {
  id           String            @id @default(cuid())
  schoolId     String
  label        String
  slug         String
  sortOrder    Int               @default(0)
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  q2AnswerTags String[]          @default([])
  results      DiagnosisResult[] @relation("ResultCourses")

  @@unique([schoolId, slug])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

model DiagnosisLifestyle {
  id        String   @id @default(cuid())
  schoolId  String
  label     String
  slug      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, slug])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

model DiagnosisGenre {
  id        String   @id @default(cuid())
  schoolId  String
  label     String
  slug      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  answerTag String?

  photoData Bytes?
  photoMime String?

  results DiagnosisResult[] @relation("ResultGenres")

  @@unique([schoolId, slug])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

model DiagnosisInstructor {
  id           String   @id @default(cuid())
  schoolId     String
  label        String
  slug         String
  sortOrder    Int      @default(0)
  isActive     Boolean  @default(true)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  photoData    Bytes?
  photoMime    String?
  photoUrl     String?
  charmTags    String?
  introduction String?

  results DiagnosisResult[] @relation("ResultInstructors")

  @@unique([schoolId, slug])
  @@index([schoolId, isActive])
  @@index([schoolId, sortOrder])
}

model DiagnosisInstructorCourse {
  instructorId String
  courseId     String
  schoolId     String
  createdAt    DateTime @default(now()) @db.Timestamp(6)

  @@id([instructorId, courseId])
  @@index([schoolId])
  @@index([courseId])
}

model DiagnosisInstructorGenre {
  instructorId String
  genreId      String
  schoolId     String
  createdAt    DateTime @default(now()) @db.Timestamp(6)

  @@id([instructorId, genreId])
  @@index([schoolId])
  @@index([genreId])
}

model DiagnosisInstructorCampus {
  instructorId String
  campusId     String
  schoolId     String
  createdAt    DateTime @default(now()) @db.Timestamp(6)

  @@id([instructorId, campusId])
  @@index([schoolId])
  @@index([campusId])
}

model DiagnosisResult {
  id         String   @id @default(cuid())
  schoolId   String
  title      String
  body       String?
  ctaLabel   String?
  ctaUrl     String?
  sortOrder  Int      @default(0)
  isActive   Boolean  @default(true)
  priority   Int      @default(0)
  conditions Json?
  isFallback Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campuses    DiagnosisCampus[]     @relation("ResultCampuses")
  courses     DiagnosisCourse[]     @relation("ResultCourses")
  genres      DiagnosisGenre[]      @relation("ResultGenres")
  instructors DiagnosisInstructor[] @relation("ResultInstructors")

  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

model SchoolClass {
  id          String   @id @default(cuid())
  schoolId    String
  name        String
  description String?
  levels      String[]
  targets     String[]
  genres      String[]
  schedule    String?
  isActive    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teachers TeacherClass[]

  @@index([schoolId])
  @@index([isActive])
}

model Teacher {
  id        String   @id @default(cuid())
  schoolId  String
  name      String
  photoUrl  String?
  styles    String[]
  bio       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  classes TeacherClass[]

  @@index([schoolId])
}

model TeacherClass {
  id        String   @id @default(cuid())
  classId   String
  teacherId String
  createdAt DateTime @default(now())

  clazz   SchoolClass @relation(fields: [classId], references: [id])
  teacher Teacher     @relation(fields: [teacherId], references: [id])

  @@unique([classId, teacherId])
  @@index([classId])
  @@index([teacherId])
}

/// 診断結果ページの最下部に出す「フォーム」設定（スクール単位で1つ）
model DiagnosisForm {
  id          String   @id @default(cuid())
  schoolId    String   @unique

  isActive    Boolean  @default(true)

  title       String?  // 見出し
  description String?  // 説明文（任意）

  submitType  DiagnosisFormSubmitType @default(INTERNAL)
  submitUrl   String?  // EXTERNAL / GOOGLE のときに利用

  thanksType  DiagnosisFormThanksType @default(MESSAGE)
  thanksText  String?  // MESSAGE のときに利用
  thanksUrl   String?  // REDIRECT のときに利用

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // fields
  fields      DiagnosisFormField[]

  // relation（Schoolモデルが存在する前提）
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
}

/// フォームの項目（並び順・必須・placeholderなど）
model DiagnosisFormField {
  id          String   @id @default(cuid())
  formId      String

  label       String
  type        DiagnosisFormFieldType
  required    Boolean  @default(false)
  placeholder String?

  // select用（任意）
  optionsJson Json?    // ["渋谷","新宿"] など

  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  form        DiagnosisForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@index([formId, sortOrder])
}

enum DiagnosisFormSubmitType {
  INTERNAL  // DBに保存（将来的にリード管理）
  EXTERNAL  // 外部URLにPOST（or リダイレクト/JS送信など実装方針次第）
  GOOGLE    // Googleフォームなど（submitUrlにURL）
}

enum DiagnosisFormThanksType {
  MESSAGE   // 完了メッセージ表示
  REDIRECT  // サンクスページへ遷移
}

enum DiagnosisFormFieldType {
  TEXT
  EMAIL
  TEL
  TEXTAREA
  SELECT
  CHECKBOX
  HIDDEN
}

enum UserRole {
  SUPERADMIN
  SCHOOL_ADMIN
}
