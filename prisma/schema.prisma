generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // ✅ Prisma 7以降: schema.prisma の url は廃止（prisma.config.ts 側へ）
}

model Faq {
  id           String   @id @default(uuid())
  schoolId     String   @unique
  items        Json
  updatedBy    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  ctaLabel     String?
  ctaUrl       String?
  palette      String   @default("gray")
  launcherText String?

  @@index([updatedAt])
}

model FaqLog {
  id        Int      @id @default(autoincrement())
  school    String
  sessionId String
  timestamp DateTime
  question  String
  answer    String?
  url       String?
  createdAt DateTime @default(now())

  @@index([school])
  @@index([sessionId])
  @@index([timestamp])
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  role         UserRole
  schoolId     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([schoolId])
  @@index([role])
}

model SuperAdmin {
  id        String   @id @default(cuid())
  email     String   @unique
  schoolId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DiagnosisCampus {
  id        String  @id @default(cuid())
  schoolId  String
  label     String
  slug      String
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  address String?
  access  String?

  googleMapUrl      String?
  googleMapEmbedUrl String?

  results DiagnosisResult[] @relation("ResultCampuses")

  @@unique([schoolId, slug])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

model DiagnosisCourse {
  id          String   @id @default(cuid())
  schoolId    String
  label       String
  slug        String
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  description String?

  // 既存：Q2の複数回答タグ
  q2AnswerTags String[] @default([])

  // ✅ Q4削除：answerTag は不要になったので削除
  // answerTag String?

  // ✅ 追加：診断結果に表示する画像（任意）
  photoMime String?
  photoData Bytes?

  results DiagnosisResult[] @relation("ResultCourses")

  // ✅ これを追加（ビルドエラー解消ポイント）
  scheduleSlots DiagnosisScheduleSlotCourse[]

  @@unique([schoolId, slug])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
  // @@index([schoolId, answerTag])  // ✅ Q4削除により不要
}

model DiagnosisLifestyle {
  id        String   @id @default(cuid())
  schoolId  String
  label     String
  slug      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, slug])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

model DiagnosisInstructor {
  id        String  @id @default(cuid())
  schoolId  String
  label     String
  slug      String
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  photoData    Bytes?
  photoMime    String?
  photoUrl     String?
  charmTags    String?
  introduction String?

  results DiagnosisResult[] @relation("ResultInstructors")

  // ✅ Q4削除：q4Options を削除
  // q4Options DiagnosisInstructorQ4Option[] @relation("InstructorQ4Options")

  // ✅ 追加：Q6 option 紐づけ（逆側）
  q6Options DiagnosisInstructorQ6Option[] @relation("InstructorQ6Options")

  @@unique([schoolId, slug])
  @@index([schoolId, isActive])
  @@index([schoolId, sortOrder])
}

model DiagnosisInstructorCourse {
  instructorId String
  courseId     String
  schoolId     String
  createdAt    DateTime @default(now()) @db.Timestamp(6)

  @@id([instructorId, courseId])
  @@index([schoolId])
  @@index([courseId])
}

// ✅ Q4削除：DiagnosisInstructorGenre を削除
// model DiagnosisInstructorGenre { ... }

model DiagnosisInstructorCampus {
  instructorId String
  campusId     String
  schoolId     String
  createdAt    DateTime @default(now()) @db.Timestamp(6)

  @@id([instructorId, campusId])
  @@index([schoolId])
  @@index([campusId])
}

model DiagnosisResult {
  id         String  @id @default(cuid())
  schoolId   String
  title      String
  body       String?
  ctaLabel   String?
  ctaUrl     String?
  sortOrder  Int     @default(0)
  isActive   Boolean @default(true)
  priority   Int     @default(0)
  conditions Json?
  isFallback Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campuses    DiagnosisCampus[]     @relation("ResultCampuses")
  courses     DiagnosisCourse[]     @relation("ResultCourses")
  // ✅ Q4削除：genres を削除
  // genres   DiagnosisGenre[]      @relation("ResultGenres")
  instructors DiagnosisInstructor[] @relation("ResultInstructors")

  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

model SchoolClass {
  id          String   @id @default(cuid())
  schoolId    String
  name        String
  description String?
  levels      String[]
  targets     String[]
  genres      String[]
  schedule    String?
  isActive    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teachers TeacherClass[]

  @@index([schoolId])
  @@index([isActive])
}

model Teacher {
  id       String   @id @default(cuid())
  schoolId String
  name     String
  photoUrl String?
  styles   String[]
  bio      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  classes TeacherClass[]

  @@index([schoolId])
}

model TeacherClass {
  id        String   @id @default(cuid())
  classId   String
  teacherId String
  createdAt DateTime @default(now())

  clazz   SchoolClass @relation(fields: [classId], references: [id])
  teacher Teacher     @relation(fields: [teacherId], references: [id])

  @@unique([classId, teacherId])
  @@index([classId])
  @@index([teacherId])
}

enum Weekday {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN

  @@map("Weekday")
}

model DiagnosisScheduleSlot {
  id       String @id @default(cuid())
  schoolId String

  weekday   Weekday
  genreText String // 例: "K-POP"（※表示用テキストとしては残してOK）
  timeText  String
  teacher   String
  place     String

  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  courses DiagnosisScheduleSlotCourse[]

  @@index([schoolId, weekday, isActive])
}

model DiagnosisScheduleSlotCourse {
  slotId   String
  courseId String

  slot   DiagnosisScheduleSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)
  course DiagnosisCourse       @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@id([slotId, courseId])
}

model DiagnosisForm {
  id       String @id @default(cuid())
  schoolId String @unique

  isActive Boolean @default(true)

  title       String?
  description String?

  submitType String  @default("INTERNAL")
  submitUrl  String?

  thanksType String  @default("MESSAGE")
  thanksText String?
  thanksUrl  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  fields DiagnosisFormField[]

  @@index([schoolId])
}

model DiagnosisFormField {
  id     String @id @default(cuid())
  formId String

  label       String
  type        String
  required    Boolean @default(false)
  placeholder String?

  optionsJson Json?

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  form DiagnosisForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@index([formId, sortOrder])
}

model DiagnosisFormEmailSetting {
  id       String @id @default(cuid())
  schoolId String @unique

  isActive Boolean @default(true)

  fromName  String?
  fromEmail String?
  replyTo   String?

  adminTo  String
  adminCc  String?
  adminBcc String?

  adminSubjectTemplate String  @default("【診断フォーム】新しいお問い合わせ")
  adminBodyTemplate    String?

  userAutoReplyEnabled Boolean @default(true)
  userSubjectTemplate  String  @default("お問い合わせありがとうございます")
  userBodyTemplate     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
}

// ✅ Q4削除：DiagnosisInstructorQ4Option を削除
// model DiagnosisInstructorQ4Option { ... }

model DiagnosisInstructorQ6Option {
  id           String @id @default(cuid())
  schoolId     String
  instructorId String
  optionId     String

  instructor DiagnosisInstructor @relation("InstructorQ6Options", fields: [instructorId], references: [id], onDelete: Cascade)

  @@unique([schoolId, instructorId, optionId])
  @@index([schoolId, optionId])
  @@index([instructorId])
}

enum UserRole {
  SUPERADMIN
  SCHOOL_ADMIN
}
