generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model Faq {
  id           String   @id @default(uuid())
  schoolId     String   @unique
  items        Json
  updatedBy    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  ctaLabel     String?
  ctaUrl       String?
  palette      String   @default("gray")
  launcherText String?

  @@index([updatedAt])
}

model FaqLog {
  id        Int      @id @default(autoincrement())
  school    String
  sessionId String
  timestamp DateTime
  question  String
  answer    String?
  url       String?
  createdAt DateTime @default(now())

  @@index([school])
  @@index([sessionId])
  @@index([timestamp])
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  role         UserRole
  schoolId     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([schoolId])
  @@index([role])
}

model SuperAdmin {
  id        String   @id @default(cuid())
  email     String   @unique
  schoolId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DiagnosisCampus {
  id           String            @id @default(cuid())
  schoolId     String
  label        String
  slug         String
  sortOrder    Int               @default(0)
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  address      String?
  access       String?
  googleMapUrl String?
  results      DiagnosisResult[] @relation("ResultCampuses")

  @@unique([schoolId, slug])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

model DiagnosisCourse {
  id           String            @id @default(cuid())
  schoolId     String
  label        String
  slug         String
  sortOrder    Int               @default(0)
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  q2AnswerTags String[]          @default([])
  results      DiagnosisResult[] @relation("ResultCourses")

  @@unique([schoolId, slug])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

model DiagnosisLifestyle {
  id        String   @id @default(cuid())
  schoolId  String
  label     String
  slug      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, slug])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}


model DiagnosisGenre {
  id        String            @id @default(cuid())
  schoolId  String
  label     String
  slug      String
  sortOrder Int               @default(0)
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  answerTag String?

  // ✅ 追加：診断結果に表示する画像（DB保存）
  photoData Bytes?
  photoMime String?

  results   DiagnosisResult[] @relation("ResultGenres")

  @@unique([schoolId, slug])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}


model DiagnosisInstructor {
  id           String            @id @default(cuid())
  schoolId     String
  label        String
  slug         String
  sortOrder    Int               @default(0)
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  photoData    Bytes?
  photoMime    String?
  photoUrl     String?
  charmTags    String?
  introduction String?
  results      DiagnosisResult[] @relation("ResultInstructors")

  @@unique([schoolId, slug])
  @@index([schoolId, isActive])
  @@index([schoolId, sortOrder])
}

model DiagnosisInstructorCourse {
  instructorId String
  courseId     String
  schoolId     String
  createdAt    DateTime @default(now()) @db.Timestamp(6)

  @@id([instructorId, courseId])
  @@index([schoolId])
  @@index([courseId])
}

model DiagnosisInstructorGenre {
  instructorId String
  genreId      String
  schoolId     String
  createdAt    DateTime @default(now()) @db.Timestamp(6)

  @@id([instructorId, genreId])
  @@index([schoolId])
  @@index([genreId])
}

model DiagnosisInstructorCampus {
  instructorId String
  campusId     String
  schoolId     String
  createdAt    DateTime @default(now()) @db.Timestamp(6)

  @@id([instructorId, campusId])
  @@index([schoolId])
  @@index([campusId])
}

model DiagnosisResult {
  id          String                @id @default(cuid())
  schoolId    String
  title       String
  body        String?
  ctaLabel    String?
  ctaUrl      String?
  sortOrder   Int                   @default(0)
  isActive    Boolean               @default(true)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  priority    Int                   @default(0)
  conditions  Json?
  isFallback  Boolean               @default(false)
  campuses    DiagnosisCampus[]     @relation("ResultCampuses")
  courses     DiagnosisCourse[]     @relation("ResultCourses")
  genres      DiagnosisGenre[]      @relation("ResultGenres")
  instructors DiagnosisInstructor[] @relation("ResultInstructors")

  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

model SchoolClass {
  id          String         @id @default(cuid())
  schoolId    String
  name        String
  description String?
  levels      String[]
  targets     String[]
  genres      String[]
  schedule    String?
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  teachers    TeacherClass[]

  @@index([schoolId])
  @@index([isActive])
}

model Teacher {
  id        String         @id @default(cuid())
  schoolId  String
  name      String
  photoUrl  String?
  styles    String[]
  bio       String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  classes   TeacherClass[]

  @@index([schoolId])
}

model TeacherClass {
  id        String      @id @default(cuid())
  classId   String
  teacherId String
  createdAt DateTime    @default(now())
  clazz     SchoolClass @relation(fields: [classId], references: [id])
  teacher   Teacher     @relation(fields: [teacherId], references: [id])

  @@unique([classId, teacherId])
  @@index([classId])
  @@index([teacherId])
}

enum UserRole {
  SUPERADMIN
  SCHOOL_ADMIN
}
