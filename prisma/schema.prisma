generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Faq {
  id       String @id @default(uuid())
  schoolId String @unique
  items    Json

  palette      String  @default("gray")
  ctaLabel     String?
  ctaUrl       String?
  launcherText String?

  updatedBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([updatedAt])
}

model FaqLog {
  id        Int      @id @default(autoincrement())
  school    String
  sessionId String
  timestamp DateTime

  question String
  answer   String?
  url      String?

  createdAt DateTime @default(now())

  @@index([school])
  @@index([sessionId])
  @@index([timestamp])
}

enum UserRole {
  SUPERADMIN
  SCHOOL_ADMIN
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  role         UserRole
  schoolId     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([role])
}

model SuperAdmin {
  id        String   @id @default(cuid())
  email     String   @unique
  schoolId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/////////////////////////////////////////
// ここから診断機能用のモデル
/////////////////////////////////////////

model DiagnosisCampus {
  id        String  @id @default(cuid())
  schoolId  String
  label     String
  slug      String
  sortOrder Int     @default(0)
  isOnline  Boolean @default(false)
  isActive  Boolean @default(true)

  // 診断結果に紐づく（多対多：暗黙OK）
  results DiagnosisResult[] @relation("ResultCampuses")

  // ✅ 講師紐づけ：暗黙M2Mをやめて中間へ
  instructorLinks DiagnosisInstructorCampus[]

  address      String?
  access       String?
  googleMapUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, slug])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

model DiagnosisCourse {
  id        String  @id @default(cuid())
  schoolId  String
  label     String
  slug      String
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  q2AnswerTags String[] @default([])

  // 診断結果に紐づく（多対多：暗黙OK）
  results DiagnosisResult[] @relation("ResultCourses")

  // ✅ 講師紐づけ：中間へ（今回のエラー原因）
  instructorLinks DiagnosisInstructorCourse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, slug])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

model DiagnosisGenre {
  id       String @id @default(cuid())
  schoolId String
  label    String
  slug     String

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  answerTag String?

  // 診断結果に紐づく（多対多：暗黙OK）
  results DiagnosisResult[] @relation("ResultGenres")

  // ✅ 講師紐づけ：暗黙M2Mをやめて中間へ
  instructorLinks DiagnosisInstructorGenre[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, slug])
  @@unique([schoolId, answerTag])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
  @@index([schoolId, answerTag])
}

model DiagnosisInstructor {
  id        String  @id @default(cuid())
  schoolId  String
  label     String
  slug      String
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  photoMime String?
  photoData Bytes?

  courses  DiagnosisInstructorCourse[]
  genres   DiagnosisInstructorGenre[]
  campuses DiagnosisInstructorCampus[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, slug])
  @@index([schoolId, isActive])
}

// ✅ 講師×コース（明示中間テーブル）
model DiagnosisInstructorCourse {
  instructorId String
  courseId     String
  schoolId     String

  instructor DiagnosisInstructor @relation(fields: [instructorId], references: [id])
  course     DiagnosisCourse     @relation(fields: [courseId], references: [id])

  createdAt DateTime @default(now())

  @@id([instructorId, courseId])
  @@index([schoolId])
}

// ✅ 講師×ジャンル（明示中間テーブル）
model DiagnosisInstructorGenre {
  instructorId String
  genreId      String
  schoolId     String

  instructor DiagnosisInstructor @relation(fields: [instructorId], references: [id])
  genre      DiagnosisGenre      @relation(fields: [genreId], references: [id])

  createdAt DateTime @default(now())

  @@id([instructorId, genreId])
  @@index([schoolId])
}

// ✅ 講師×校舎（明示中間テーブル）
model DiagnosisInstructorCampus {
  instructorId String
  campusId     String
  schoolId     String

  instructor DiagnosisInstructor @relation(fields: [instructorId], references: [id])
  campus     DiagnosisCampus     @relation(fields: [campusId], references: [id])

  createdAt DateTime @default(now())

  @@id([instructorId, campusId])
  @@index([schoolId])
}

model DiagnosisResult {
  id       String @id @default(cuid())
  schoolId String
  title    String
  body     String?
  ctaLabel String?
  ctaUrl   String?

  priority   Int     @default(0)
  conditions Json?
  isFallback Boolean @default(false)

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  campuses    DiagnosisCampus[]     @relation("ResultCampuses")
  courses     DiagnosisCourse[]     @relation("ResultCourses")
  genres      DiagnosisGenre[]      @relation("ResultGenres")
  instructors DiagnosisInstructor[] @relation("ResultInstructors")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId, priority])
  @@index([schoolId, isFallback])
  @@index([schoolId, sortOrder])
  @@index([schoolId, isActive])
}

// --- 既存運用モデル（そのまま） ---

model SchoolClass {
  id          String   @id @default(cuid())
  schoolId    String
  name        String
  description String?
  levels      String[]
  targets     String[]
  genres      String[]
  schedule    String?
  isActive    Boolean  @default(true)

  teachers TeacherClass[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([isActive])
}

model Teacher {
  id       String   @id @default(cuid())
  schoolId String
  name     String
  photoUrl String?
  styles   String[]
  bio      String?

  classes TeacherClass[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
}

model TeacherClass {
  id        String @id @default(cuid())
  classId   String
  teacherId String

  clazz   SchoolClass @relation(fields: [classId], references: [id])
  teacher Teacher     @relation(fields: [teacherId], references: [id])

  createdAt DateTime @default(now())

  @@unique([classId, teacherId])
  @@index([classId])
  @@index([teacherId])
}
